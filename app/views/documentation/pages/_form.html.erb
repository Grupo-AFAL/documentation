<%= form_with(model: page) do |form| %>
  <% if page.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(page.errors.count, "error") %> prohibited this page from being saved:</h2>

      <ul>
        <% page.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= form.slim_select_group :parent_id, @pages.map {|p| [p.title, p.id] }, include_blank: 'Select page parent', label: false %>
  <%= form.text_field_group :title, label: false, placeholder: 'Title', class: 'is-large' %>
  <%= form.text_field_group :description, label: false, placeholder: 'Description' %>

  <div
    data-turbo-cache="false"
    class="rich-text-editor-component input mb-4 rich-editor-content"
    data-controller="rich-text-editor"
    data-rich-text-editor-content-value='<%= page.content %>'
    data-rich-text-editor-placeholder-value='Write page content here...'
  >
    <div class="rich-text-editor-menu" data-rich-text-editor-target="bubbleMenu">

      <%= render Bali::Dropdown::Component.new(data: { 'rich-text-editor-target': 'nodeSelect'}) do |c| %>
        <% c.trigger(data: { action: 'rich-text-editor#openNodeSelect' }) do %>
          <span class="text" data-rich-text-editor-target="nodeSelectTrigger">Text</span>
          <%= icon_tag('chevron-down', class: 'toolbar-icon') %>
        <% end %>

        <%= c.item(class: 'text', data: { action: 'rich-text-editor#setParagraph', 'rich-text-editor-target': 'text' }) { 'Text' } %>
        <%= c.item(class: 'h1', data: { action: 'rich-text-editor#toggleH1', 'rich-text-editor-target': 'h1' }) { 'Heading 1' } %>
        <%= c.item(class: 'h2', data: { action: 'rich-text-editor#toggleH2', 'rich-text-editor-target': 'h2' }) { 'Heading 2' } %>
        <%= c.item(class: 'h3', data: { action: 'rich-text-editor#toggleH3', 'rich-text-editor-target': 'h3' }) { 'Heading 2' } %>
        <%= c.item(class: 'ul', data: { action: 'rich-text-editor#toggleBulletList', 'rich-text-editor-target': 'ul' }) { 'Bulleted list' } %>
        <%= c.item(class: 'ol', data: { action: 'rich-text-editor#toggleOrderedList', 'rich-text-editor-target': 'ol' }) { 'Ordered list' } %>
        <%= c.item(class: 'blockquote', data: { action: 'rich-text-editor#toggleBlockquote', 'rich-text-editor-target': 'blockquote' }) { 'Quote' } %>
        <%= c.item(class: 'codeBlock', data: { action: 'rich-text-editor#toggleCodeBlock', 'rich-text-editor-target': 'codeBlock' }) { 'Code' } %>
      <% end %>

      <%= render Bali::Dropdown::Component.new(close_on_click: false, data: { 'rich-text-editor-target': 'linkPanel' }) do |c| %>
        <% c.trigger(class: 'link', data: { action: 'rich-text-editor#openLinkPanel' }) do %>
          <span>Link</span>
          <%= icon_tag('arrow-right-up', class: 'toolbar-icon') %>
        <% end %>

        <div class="link-panel">
          <%= render(Bali::Tabs::Component.new(class: 'is-small')) do |c| %>
            <%= c.tab(title: 'URL', active: true) do %>
              <div contenteditable="true"
                    class="input is-small"
                    placeholder="Ingresa la URL"
                    data-rich-text-editor-target="linkInput"
                    data-action="keydown->rich-text-editor#saveLinkUrl">
              </div>
            <% end %>

            <%= c.tab(title: 'Pages', active: false) do %>
              <% @pages.each do |page| %>
                <%= tag.a page.title, class: 'page-link',
                    data: {
                      action: 'click->rich-text-editor#savePageLink',
                      id: page.id,
                      url: page_url(page) } %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      </div>

      <%= render Bali::Dropdown::Component.new(data: { 'rich-text-editor-target': 'tablePanel' }) do |c| %>
        <% c.trigger(data: { action: 'rich-text-editor#openTablePanel' }) do %>
          <span>Table</span>
          <%= icon_tag('chevron-down', class: 'toolbar-icon') %>
        <% end %>

        <%= c.item(data: { action: 'rich-text-editor#insertTable' }) { 'Insert Table' } %>
        <%= c.item(class: 'modifier disabled', data: { action: 'rich-text-editor#addColumnBefore', 'rich-text-editor-target': 'tableModifier' }) { 'Insert Left' } %>
        <%= c.item(class: 'modifier disabled', data: { action: 'rich-text-editor#addColumnAfter', 'rich-text-editor-target': 'tableModifier' }) { 'Insert Right' } %>
        <%= c.item(class: 'modifier disabled', data: { action: 'rich-text-editor#addRowBefore', 'rich-text-editor-target': 'tableModifier' }) { 'Insert Above' } %>
        <%= c.item(class: 'modifier disabled', data: { action: 'rich-text-editor#addRowAfter', 'rich-text-editor-target': 'tableModifier' }) { 'Insert Below' } %>
        <%= c.item(class: 'modifier disabled', data: { action: 'rich-text-editor#deleteColumn', 'rich-text-editor-target': 'tableModifier' }) { 'Remove Column' } %>
        <%= c.item(class: 'modifier disabled', data: { action: 'rich-text-editor#deleteRow', 'rich-text-editor-target': 'tableModifier' }) { 'Remove Row' } %>
      <% end %>

      <a class="mark bold" data-action="rich-text-editor#toggleBold" data-rich-text-editor-target="bold">B</a>
      <a class="mark italic" data-action="rich-text-editor#toggleItalic" data-rich-text-editor-target="italic">I</a>
      <a class="mark underline" data-action="rich-text-editor#toggleUnderline" data-rich-text-editor-target="underline">U</a>
    </div>

    <div data-rich-text-editor-target="tippy"></div>
    <%= form.hidden_field :content, 'data-rich-text-editor-target': 'output' %>
  </div>

  <%= form.submit_actions 'Guardar', class: 'button is-primary' %>
<% end %>
